<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>NewYear Fireworks</title>
  <style>
html, body{
  margin:0; padding:0; height:100%;
  overflow:hidden; touch-action:none;
  background:transparent;
  font-family: ui-sans-serif, system-ui, -apple-system, "PingFang SC","Microsoft YaHei";
}
canvas{ position:fixed; inset:0; width:100vw; height:100vh; display:block; z-index:1; }

/* ===============================
   Immersive background
================================ */
.bg{ position:fixed; inset:0; z-index:0; pointer-events:none; overflow:hidden; }
.sky{
  position:absolute; inset:-12%;
  background:
    radial-gradient(ellipse at 50% 85%,
      rgba(255,170,95,0.28) 0%,
      rgba(255,135,70,0.14) 28%,
      rgba(0,0,0,0) 62%
    ),
    linear-gradient(to bottom,
      #02040b 0%,
      #061027 35%,
      #081a3a 55%,
      #0a2348 70%,
      #0b2a52 86%,
      #0b2f58 100%
    );
  animation: skyDrift 140s linear infinite;
}
@keyframes skyDrift{
  0%{ transform: translate3d(0,0,0) scale(1.02); }
  50%{ transform: translate3d(-2%,1.2%,0) scale(1.02); }
  100%{ transform: translate3d(0,0,0) scale(1.02); }
}
.mountains{
  position:absolute; left:-5%; right:-5%;
  bottom:20vh; height:32vh; opacity:0.33;
  background:
    radial-gradient(120% 100% at 12% 100%, rgba(0,0,0,0.70) 0%, rgba(0,0,0,0) 62%),
    radial-gradient(140% 110% at 38% 100%, rgba(0,0,0,0.72) 0%, rgba(0,0,0,0) 64%),
    radial-gradient(130% 105% at 64% 100%, rgba(0,0,0,0.74) 0%, rgba(0,0,0,0) 62%),
    radial-gradient(120% 100% at 88% 100%, rgba(0,0,0,0.76) 0%, rgba(0,0,0,0) 63%);
  filter: blur(.4px);
}
.water{
  position:absolute; left:0; right:0; bottom:0; height:34vh;
  background:
    radial-gradient(ellipse at 50% 0%,
      rgba(255,200,125,0.32) 0%,
      rgba(255,160,95,0.16) 22%,
      rgba(255,140,80,0.06) 40%,
      rgba(0,0,0,0) 70%
    ),
    linear-gradient(to bottom,
      rgba(10,20,45,0.10) 0%,
      rgba(6,12,30,0.55) 35%,
      rgba(2,6,16,0.95) 100%
    );
}
.water::before{
  content:""; position:absolute; inset:0;
  background: repeating-linear-gradient(
    to bottom,
    rgba(255,255,255,0.06) 0px,
    rgba(255,255,255,0.00) 6px,
    rgba(255,255,255,0.00) 14px
  );
  opacity:0.20; mix-blend-mode: screen;
  filter: blur(1.2px);
  animation: waterShimmer 10s ease-in-out infinite;
}
@keyframes waterShimmer{
  0%{ transform: translate3d(0,0,0); }
  50%{ transform: translate3d(0,2%,0); }
  100%{ transform: translate3d(0,0,0); }
}

/* Theme: film */
body[data-theme="film"] .sky{
  background:
    radial-gradient(ellipse at 50% 85%, rgba(255,170,95,0.10) 0%, rgba(0,0,0,0) 60%),
    linear-gradient(to bottom, #000000 0%, #030712 45%, #08122a 100%);
}
body[data-theme="film"] .mountains{ opacity:0.18; }
body[data-theme="film"] .water{
  background: linear-gradient(to bottom,
    rgba(255,190,120,0.08) 0%,
    rgba(0,0,0,0.0) 20%,
    rgba(0,0,0,0.92) 100%
  );
}

/* ===============================
   Top control bar (match screenshot)
   - single rounded bar on wide screens
   - wraps nicely on mobile
================================ */
:root{
  --bar-bg: rgba(12,18,35,.55);
  --bar-border: rgba(255,255,255,.10);
  --text: rgba(255,255,255,.92);
  --muted: rgba(255,255,255,.70);
  --chip-bg: rgba(255,255,255,.06);
  --chip-border: rgba(255,255,255,.10);
  --radius: 18px;
}

.topbar{
  position: fixed;
  top: 14px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 10;

  width: min(96vw, 1180px);
  pointer-events: none;
}

.bar{
  pointer-events: auto;
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  align-items: center;

  padding: clamp(8px, 1.6vw, 12px);
  border-radius: 22px;
  background: var(--bar-bg);
  border: 1px solid var(--bar-border);
  backdrop-filter: blur(10px);
  box-shadow: 0 10px 26px rgba(0,0,0,.25);

  color: var(--text);
  user-select: none;
}

.grp{
  display:flex; align-items:center; gap:10px;
  min-width: 0;
}

.label{
  font-size: clamp(12px, 1.2vw, 14px);
  color: var(--muted);
  white-space: nowrap;
}

select, button, input[type="range"]{
  font: inherit;
  color: var(--text);
  background: var(--chip-bg);
  border: 1px solid var(--chip-border);
  border-radius: 14px;
  outline: none;
}

select, button{
  padding: .55em .9em;
  font-size: clamp(12px, 1.2vw, 14px);
  line-height: 1.1;
  white-space: nowrap;
}

select{
  max-width: min(52vw, 420px);
  min-width: 160px;
}

button{
  cursor: pointer;
}
button:hover{ background: rgba(255,255,255,.10); }
button:active{ transform: translateY(1px); }

.rangeWrap{
  display:flex; align-items:center; gap:10px;
  min-width: min(44vw, 420px);
  flex: 1 1 260px;
}
input[type="range"]{
  width: 100%;
  padding: 0;
  accent-color: #3b82f6; /* blue like screenshot */
}

.switch{
  display:flex; align-items:center; gap:8px;
  padding: .45em .65em;
  border-radius: 14px;
  background: var(--chip-bg);
  border: 1px solid var(--chip-border);
}
.switch input{ accent-color: #3b82f6; }

.val{
  font-size: clamp(12px, 1.2vw, 14px);
  color: var(--text);
  min-width: 3.2em;
  text-align: right;
}

/* Mobile: bar fills width and stacks cleanly */
@media (max-width: 700px){
  .topbar{ top: 10px; }
  .bar{ gap: 8px; border-radius: 18px; }
  select{ min-width: 44vw; }
  .rangeWrap{ min-width: 100%; flex: 1 1 100%; }
}

/* Very small: make selects full width, buttons wrap */
@media (max-width: 420px){
  select{ min-width: 100%; max-width: 100%; }
  .grp{ flex: 1 1 100%; }
  .bar{ padding: 10px; }
}

/* ===============================
   Bless / Hint
================================ */
.hint{
  position:fixed; left:12px; right:12px; bottom:14px;
  z-index:10; display:flex; justify-content:center; pointer-events:none;
}
.hint>div{
  background: rgba(12,18,35,.42);
  border:1px solid rgba(255,255,255,.10);
  backdrop-filter: blur(8px);
  border-radius:999px;
  padding:8px 14px;
  color: rgba(255,255,255,.85);
  font-size:12px;
  box-shadow: 0 10px 26px rgba(0,0,0,.22);
}
/* å·¦ä¸‹è§’æ¸©é¦¨æç¤º */
.film-tip{
  position: fixed;
  left: 14px;
  bottom: 70px; /* é¿å¼€åŸæœ‰ hint */
  z-index: 10;
  pointer-events: none;

  background: rgba(12,18,35,.45);
  border: 1px solid rgba(255,255,255,.12);
  backdrop-filter: blur(8px);
  border-radius: 999px;
  padding: 6px 12px;

  font-size: 12px;
  color: rgba(255,255,255,.85);
  box-shadow: 0 8px 20px rgba(0,0,0,.25);

  opacity: .85;
}



.bless{
  position:fixed; inset:0;
  display:grid; place-items:center;
  z-index:9; pointer-events:none;
}
.bless .text{
  padding:10px 18px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.18);
  background: rgba(10,16,40,.55);
  backdrop-filter: blur(8px);
  color: rgba(255,255,255,.95);
  text-shadow: 0 0 8px rgba(255,255,255,.25);
  font-size:14px;
  letter-spacing:.5px;
  opacity:0;
  transform: translateY(6px);
  transition: opacity .5s ease, transform .5s ease;
}
.bless.show .text{ opacity:1; transform: translateY(0); }

/* subtle star specks */
body::before{
  content:"";
  position:fixed; inset:0; pointer-events:none;
  background-image:
    radial-gradient(1px 1px at 15% 25%, rgba(255,255,255,.35), transparent),
    radial-gradient(1.5px 1.5px at 75% 40%, rgba(255,255,255,.28), transparent),
    radial-gradient(1px 1px at 60% 75%, rgba(255,255,255,.25), transparent),
    radial-gradient(1.5px 1.5px at 30% 65%, rgba(255,255,255,.3), transparent);
  opacity:.25;
}
body::after{
  content:"";
  position:fixed; left:0; right:0; bottom:-10%;
  height:40vh; pointer-events:none;
  background: radial-gradient(ellipse at center,
    rgba(255,150,70,0.25) 0%,
    rgba(255,120,60,0.12) 35%,
    transparent 70%
  );
  filter: blur(30px);
}
</style>
</head>
<body>
	
  <div class="bg">
    <div class="sky"></div>
    <div class="mountains"></div>
    <div class="water"></div>
  </div>
	
	
  <canvas id="c"></canvas>

  <!-- Background music (mobile browsers require a user gesture to start audio) -->
  <audio id="bgm" src="audio/bgm.mp3" preload="auto" loop playsinline webkit-playsinline></audio>
  <div class="topbar">
    <div class="bar">
      <div class="grp">
        <span class="label">ä¸»é¢˜</span>
        <select id="theme">
          <option value="warm" selected>æš–è‰²çœŸå®æ¹–é¢</option>
          <option value="film">æç®€ç”µå½±è´¨æ„Ÿ</option>
        </select>
      </div>

      <div class="grp" style="flex:1 1 360px;">
        <span class="label">çƒŸèŠ±ç±»å‹</span>
        <select id="type">
          <option value="goldWillow">ä¹å¤©æ½æœˆï¼ˆé‡‘æŸ³å¤§ä¼ï¼‰</option>
          <option value="blueCore">è“èŠ¯é“¶é±¼ï¼ˆè“æ ¸+é“¶ä¸ï¼‰</option>
          <option value="angelWings">å¤©ä½¿ç¿…è†€ï¼ˆå¯¹ç§°ç¾½ç¿¼ï¼‰</option>
          <option value="wishTree">é»„é‡‘è®¸æ„¿æ ‘ï¼ˆå–·æ³‰+æé›¨ï¼‰</option>
          <option value="jellyfish">æ°´æ¯çƒŸèŠ±ï¼ˆä¼ç›–+è§¦é¡»ï¼‰</option>
          <option value="rainbowSmoke">æ­¤ç”Ÿä¸æ¢ï¼ˆå½©è‰²çƒŸæŸ“ï¼‰</option>
          <option value="blueCluster">è“è‰²ç¾¤çˆ†ï¼ˆå¤šç°‡çˆ†é—ªï¼‰</option>
        </select>
      </div>

      <div class="grp">
        <button id="burst">æ¥ä¸€å‘</button>
        <button id="show">çƒŸèŠ±ç§€</button>
      </div>

      <div class="grp rangeWrap">
        <span class="label">å¼ºåº¦</span>
        <input id="power" type="range" min="0.6" max="1.8" step="0.05" value="1.0" />
        <span id="powerText" class="val">1.00</span>
      </div>

      <label class="switch">
        <input id="blessingToggle" type="checkbox" checked />
        <span class="label" style="color:var(--text);">ç¥ç¦</span>
      </label>

      <label class="switch">
        <input id="lowPower" type="checkbox" />
        <span class="label" style="color:var(--text);">ä½ç«¯æœº</span>
      </label>

      <button id="clear">æ¸…å±</button>
    </div>
  </div>
<div class="card range">
      <span class="label">å¼ºåº¦</span>
      <input id="power" type="range" min="0.6" max="1.8" step="0.05" value="1.0" />
      <span id="powerText" class="label">1.00</span>
    </div>

    <div class="card opts">
      <label style="display:flex; gap:6px; align-items:center;">
        <input id="blessingToggle" type="checkbox" checked />
        <span class="label">ç¥ç¦</span>
      </label>
      <label style="display:flex; gap:6px; align-items:center;">
        <input id="lowPower" type="checkbox" />
        <span class="label">ä½ç«¯æœº</span>
      </label>
      <button id="clear">æ¸…å±</button>
    </div>
  </div>

  <div class="bless show" id="bless">
    <div class="text" id="blessText">è½»ç‚¹å±å¹•ï¼Œç‚¹äº®å¤œç©ºâœ¨</div>
  </div>

  <div class="hint"><div>ç‚¹å‡»å‘å°„ï½œé•¿æŒ‰è¿å‘ï½œåŒå‡»å¤§çˆ†ï½œæ›´åƒè§†é¢‘çš„æ‹–å°¾ä¸å¼€èŠ±</div></div>
  
  <div class="film-tip">
    ğŸ¬ ä¸»é¢˜åˆ‡æ¢æˆã€Œæç®€ç”µå½±è´¨æ„Ÿã€æ•ˆæœæ›´å¥½å“¦ âœ¨
  </div>

  

  <script src="./js/fireworks.js"></script>
  <script>
    const canvas = document.getElementById('c');

    const ui = {
      type: document.getElementById('type'),
      burst: document.getElementById('burst'),
      show: document.getElementById('show'),
      power: document.getElementById('power'),
      powerText: document.getElementById('powerText'),
      blessingToggle: document.getElementById('blessingToggle'),
      lowPower: document.getElementById('lowPower'),
      clear: document.getElementById('clear'),
      bless: document.getElementById('bless'),
      blessText: document.getElementById('blessText'),
    };

    const engine = new FireworksEngine(canvas);

    // ===== ç¥ç¦è½®æ’­ï¼ˆæ¯æ¬¡ç‚¹å‡»åªåˆ‡æ¢ä¸€å¥ï¼‰=====
    const blessingList = [
      'æ„¿ä½ æ–°ä¸€å¹´ï¼Œå¹³å®‰é¡ºé‚ï¼Œè¿œç¦»æ‰€æœ‰çƒ¦æ¼ã€‚',
	  'æ–°çš„ä¸€é¡µç¿»å¼€äº†ï¼Œæ…¢æ…¢èµ°å°±å¥½',
      'æ„¿ä½ åœ¨å¤œè‰²é‡Œå®‰ç„¶å…¥æ¢¦ï¼Œåœ¨æ¸…æ™¨é‡Œå«ç¬‘é†’æ¥ã€‚',
	  'ç¯å…³äº†ï¼Œä¸–ç•Œå°±å®‰é™äº†ã€‚',
      'æ„¿ä¸–ç•Œå¾…ä½ æ¸©æŸ”ï¼Œè€Œä½ å§‹ç»ˆæœ‰å‹‡æ°”åšæœ€çœŸå®çš„è‡ªå·±ã€‚',
	  'åªè¦å¿ƒé‡Œåšå®šï¼Œå°±å·²ç»è¶³å¤Ÿ',
      'æ„¿æ‰€è¡Œä¹‹å¤„çš†æœ‰å…‰äº®ï¼Œå¿ƒä¸­å¸¸æš–ï¼Œèº«æ—å¸¸çˆ±ã€‚',
	  'æ—¥å­ä¼šæŒ‰è‡ªå·±çš„èŠ‚å¥å±•å¼€ã€‚',
	  'è¿™ä¸€å¹´çš„æ—¶é—´è¾›è‹¦äº†',
	  'æ˜¯æ—¶å€™è®©çš„å·±æ”¾æ¾äº†',
	  'æ‰€ä»¥â€¦â€¦',
	  'è¯·åƒä¸ªå°å­©ä¸€æ ·å¿«ä¹çš„æ”¾çƒŸèŠ±å§ï¼'
    ];
    const afterFour = 'Happy New Year!';
    const afterFive = 'ç¥ä½ æ–°å¹´å¿«ä¹~';

    let blessCount = 0;
    let _lastBlessStamp = -1;

   function setBless(t) {
     if (!ui.blessText) return;
   
     // å…ˆæ·¡å‡º
     ui.bless.classList.remove('show');
   
     setTimeout(() => {
       ui.blessText.textContent = t;
   
       // å†æ·¡å…¥
       ui.bless.classList.add('show');
     }, 250); // è¿™ä¸ªæ—¶é—´æ§åˆ¶æ·¡å‡ºæ—¶é•¿
   }


    function cycleBlessingOnce(ev) {
      if (!ui.blessingToggle.checked) return;
      const stamp = ev && typeof ev.timeStamp === 'number' ? ev.timeStamp : Date.now();
      if (stamp === _lastBlessStamp) return;
      _lastBlessStamp = stamp;

      blessCount += 1;
      if (blessCount >= 1 && blessCount <= blessingList.length) {
        setBless(blessingList[blessCount - 1]);
      } else if (blessCount === blessingList.length + 1) {
        setBless(afterFour);
      } else {
        setBless(afterFive);
      }
    }




    // ===== BGM: best-effort auto-start =====
    const bgm = document.getElementById('bgm');

    function tryPlayBgm(unmute = false) {
      if (!bgm) return;
      if (unmute) bgm.muted = false;
      const p = bgm.play();
      if (p && typeof p.catch === 'function') p.catch(() => {});
    }

    // Try a muted autoplay (may work on some Android browsers; often blocked on iOS/WeChat)
    if (bgm) {
      bgm.muted = true;
      tryPlayBgm(false);
    }

    // When we detect the first real user interaction, unmute + play
    engine.setOnUserGesture(() => {
      tryPlayBgm(true);
    });


    function updateBlessing() {
      ui.bless.classList.toggle('show', ui.blessingToggle.checked);
    }
    updateBlessing();

    ui.power.addEventListener('input', () => {
      ui.powerText.textContent = Number(ui.power.value).toFixed(2);
      engine.setPower(Number(ui.power.value));
    });

    ui.type.addEventListener('change', () => engine.setType(ui.type.value));
    ui.burst.addEventListener('click', () => { engine.notifyUserGesture(); engine.launchAtRandom(); });
    ui.clear.addEventListener('click', () => { engine.notifyUserGesture(); engine.clear(); });
    ui.blessingToggle.addEventListener('change', updateBlessing);
    ui.lowPower.addEventListener('change', () => engine.setLowPower(ui.lowPower.checked));

    // æ›´åƒâ€œè§†é¢‘ç¼–æ’â€çš„çƒŸèŠ±ç§€ï¼šè‡ªåŠ¨æ¢ç±»å‹ + èŠ‚å¥
    let showTimer = null;
    ui.show.addEventListener('click', () => {
      engine.notifyUserGesture();
      if (showTimer) {
        engine.stopShow();
        clearInterval(showTimer);
        showTimer = null;
        ui.show.textContent = 'çƒŸèŠ±ç§€';
        return;
      }
      ui.show.textContent = 'åœæ­¢çƒŸèŠ±ç§€';
      engine.startShow();
      showTimer = setInterval(() => engine.showTick(), 220);
    });

    // ç‚¹å‡» / é•¿æŒ‰è¿å‘ / åŒå‡»å¤§çˆ†
    let pressTimer = null;
    let repeating = false;

    function pointerDown(e) {
      engine.notifyUserGesture();
      cycleBlessingOnce(e);
      const p = engine.getPointer(e);
      engine.launch(p.x, p.y);
      repeating = true;

      pressTimer = setTimeout(() => {
        if (!repeating) return;
        const interval = engine.isLowPower() ? 260 : 160;
        const rep = setInterval(() => {
          if (!repeating) { clearInterval(rep); return; }
          const pp = engine.getPointer(e);
          engine.launch(pp.x, pp.y);
        }, interval);
      }, 240);
    }
    function pointerUp() {
      repeating = false;
      if (pressTimer) { clearTimeout(pressTimer); pressTimer = null; }
    }

    window.addEventListener('pointerdown', pointerDown, { passive:false });
    window.addEventListener('pointerup', pointerUp, { passive:true });
    window.addEventListener('pointercancel', pointerUp, { passive:true });
    window.addEventListener('dblclick', (e) => {
      engine.notifyUserGesture();
      cycleBlessingOnce(e);
      const p = engine.getPointer(e);
      engine.launch(p.x, p.y, { big: true });
    });

    engine.setType(ui.type.value);
    engine.setPower(Number(ui.power.value));
	
	// ===== ä¸»é¢˜åˆ‡æ¢ =====
	const themeSel = document.getElementById('theme');
	
	if (themeSel) {
	  themeSel.addEventListener('change', () => {
	    document.body.dataset.theme = themeSel.value;
	  });
	
	  // é¡µé¢åˆå§‹åŒ–æ—¶åº”ç”¨ä¸€æ¬¡
	  document.body.dataset.theme = themeSel.value;
	}

  </script>
</body>
</html>
